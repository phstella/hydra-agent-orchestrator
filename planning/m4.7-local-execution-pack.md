# M4.7 Local Execution Pack (Desktop-First)

Last updated: 2026-02-25

## 1. Purpose

This is the local execution plan for `M4.7` (Unified Race Cockpit UX Convergence).
It is intentionally local-first and does not require GitHub issue creation.

Use this file as the working checklist before Phase 5 starts.
This file is the canonical execution tracker for `M4.7`.

## 2. Locked Decisions

1. Scope is desktop-first for `M4.7`.
2. Primary target viewport: `>= 1280px` width.
3. Minimum supported viewport for this milestone: `>= 1024px` width with reduced rails.
4. Mobile-first and touch-first optimization are out of scope for `M4.7`.
5. Existing race determinism and IPC behavior are non-negotiable.
6. Existing design token policy remains non-negotiable (no hardcoded hex colors).

## 3. Completion Gate

`M4.7` is complete only when:
1. Operator loop is executable from one cockpit surface:
   launch -> monitor -> intervene -> observe completion -> jump to review.
2. Required smoke scenarios pass.
3. Existing race/review/interactive regressions are not introduced.

## 4. Local Tracking Table

| ID | Title | Status | Owner | Evidence |
|---|---|---|---|---|
| M4.7.1 | Cockpit Shell and Desktop Layout | TODO | unassigned | screenshot + smoke |
| M4.7.2 | Center Race Config Convergence | TODO | unassigned | screenshot + smoke |
| M4.7.3 | Right Leaderboard Card Model | TODO | unassigned | screenshot + smoke |
| M4.7.4 | Focused Live Terminal Panel | TODO | unassigned | smoke + perf note |
| M4.7.5 | Inline Intervention in Cockpit | TODO | unassigned | smoke |
| M4.7.6 | Completion Summary and Review Bridge | TODO | unassigned | smoke |
| M4.7.7 | Error and Degradation UX | TODO | unassigned | smoke |
| M4.7.8 | QA Hardening and Regression Gate | TODO | unassigned | command logs |

## 5. Local Sub-Milestones

### M4.7.1 Cockpit Shell and Desktop Layout

- Labels: `phase-4`, `area-ui`, `type-feature`
- Estimate: `M`
- Dependencies: `M4.6`
- Problem: Current IA is tab-fragmented and does not provide a persistent operator shell.
- Scope:
1. Create desktop cockpit shell with left utility rail, top status strip, center workspace, right leaderboard rail.
2. Keep existing tabs accessible but make cockpit the default landing surface.
3. Add explicit desktop breakpoints for `>= 1280` and `1024-1279`.
- Acceptance Criteria:
1. Cockpit renders stable 3-column layout at `>= 1280`.
2. Layout remains usable at `1024-1279` with compact rails.
3. Existing tabs/routes remain reachable for fallback.
- Out of Scope: mobile layout and touch gestures.

### M4.7.2 Center Race Config Convergence

- Labels: `phase-4`, `area-ui`, `type-feature`
- Estimate: `M`
- Dependencies: `M4.7.1`
- Problem: Race launch controls and status are split and not aligned with target cockpit flow.
- Scope:
1. Place race configuration block in cockpit center.
2. Show selected workspace and quick navigation to Settings.
3. Preserve adapter selection rules and experimental opt-in UX.
- Acceptance Criteria:
1. Race can be launched from center cockpit block.
2. Workspace value is visible and consistent with Settings.
3. Experimental adapter confirmation flow still blocks unsafe launch.
- Out of Scope: adapter profile editor and lane presets from Phase 5.

### M4.7.3 Right Leaderboard Card Model

- Labels: `phase-4`, `area-ui`, `type-feature`
- Estimate: `M`
- Dependencies: `M4.7.1`, `M4.7.2`
- Problem: Existing agent rail is functional but lacks cockpit-grade status density.
- Scope:
1. Replace/extend rail to card-based leaderboard with lifecycle, elapsed time, score snapshot, and mergeability hint.
2. Support explicit selected-agent focus.
3. Surface per-agent failure snippets.
- Acceptance Criteria:
1. Cards update from live stream state.
2. Selected card state is visually explicit.
3. Failed/timed-out agents show actionable compact reason text.
- Out of Scope: final ranking analytics and workflow graph cards.

### M4.7.4 Focused Live Terminal Panel

- Labels: `phase-4`, `area-ui`, `type-feature`
- Estimate: `M`
- Dependencies: `M4.7.3`
- Problem: Output display is readable but still event-log oriented and not cockpit-focused.
- Scope:
1. Bind center terminal to selected leaderboard agent.
2. Keep bounded buffering and tail-window behavior.
3. Keep stable auto-scroll with manual override.
- Acceptance Criteria:
1. Focus switch occurs within one poll interval.
2. Stream rendering remains responsive under high output.
3. Transport errors are clearly visible without blocking stream recovery.
- Out of Scope: full VT terminal emulation replacement.

### M4.7.5 Inline Intervention in Cockpit

- Labels: `phase-4`, `area-ui`, `type-feature`
- Estimate: `M`
- Dependencies: `M4.7.4`
- Problem: Intervention is currently isolated in separate interactive surface, not in cockpit context.
- Scope:
1. Integrate input composer + stop/interrupt controls directly below focused terminal.
2. Apply running-state validation and feedback.
3. Preserve structured event logging for interventions.
- Acceptance Criteria:
1. Send input works for selected running agent.
2. Stop/interrupt updates UI lifecycle state.
3. Invalid intervention attempts show clear error feedback.
- Out of Scope: resume negotiation protocol and branching conversation view.

### M4.7.6 Completion Summary and Review Bridge

- Labels: `phase-4`, `area-ui`, `type-feature`
- Estimate: `S`
- Dependencies: `M4.7.3`, `M4.7.5`
- Problem: Completion requires tab-switching before review actions.
- Scope:
1. Add completion summary panel in cockpit (winner, score, mergeability).
2. Add direct CTA to detailed diff review.
3. Keep merge actions explicit and gated.
- Acceptance Criteria:
1. Completion summary appears when run status is terminal.
2. One-click transition opens review with selected winner.
3. No auto-merge side effects.
- Out of Scope: auto-accept workflow.

### M4.7.7 Error and Degradation UX

- Labels: `phase-4`, `area-ui`, `type-feature`
- Estimate: `S`
- Dependencies: `M4.7.2`, `M4.7.3`, `M4.7.4`
- Problem: Failures exist but are not yet unified across cockpit regions.
- Scope:
1. Normalize error display across center terminal, leaderboard cards, and header strip.
2. Add compact actionable text for launch/parse/timeout/transport failure classes.
3. Preserve fallback to detailed tabs for deep troubleshooting.
- Acceptance Criteria:
1. Error class is visible in at least two relevant cockpit regions.
2. User gets clear next action text.
3. Recovery path does not require app reload for transient transport issues.
- Out of Scope: centralized toast/notification service rewrite.

### M4.7.8 QA Hardening and Regression Gate

- Labels: `phase-4`, `area-test`, `type-test`
- Estimate: `M`
- Dependencies: `M4.7.1`, `M4.7.2`, `M4.7.3`, `M4.7.4`, `M4.7.5`, `M4.7.6`, `M4.7.7`
- Problem: Cockpit convergence is high-change UI and needs explicit regression guardrails.
- Scope:
1. Add cockpit-focused smoke tests.
2. Keep prior smoke scenarios green.
3. Re-run Rust and frontend validation commands.
- Acceptance Criteria:
1. New smoke scenarios pass:
   - cockpit shell render
   - race start from cockpit
   - leaderboard live update
   - focus switch
   - intervention send success/failure
   - completion summary -> review transition
2. Existing smoke tests remain green.
3. Required command set passes:
   - `cargo test --workspace --locked --offline`
   - `cargo clippy --workspace --all-targets --locked --offline -- -D warnings`
   - `npm run lint` (`crates/hydra-app/frontend`)
   - `npm run test:smoke` (`crates/hydra-app/frontend`)
- Out of Scope: full browser E2E and performance benchmark suite.

## 6. File Touchpoint Checklist

Expected primary files:
1. `crates/hydra-app/frontend/src/App.tsx`
2. `crates/hydra-app/frontend/src/components/AgentRail.tsx`
3. `crates/hydra-app/frontend/src/components/LiveOutputPanel.tsx`
4. `crates/hydra-app/frontend/src/components/InteractiveWorkspace.tsx`
5. `crates/hydra-app/frontend/src/components/InputComposer.tsx`
6. `crates/hydra-app/frontend/src/components/ResultsScoreboard.tsx`
7. `crates/hydra-app/frontend/src/__tests__/smoke.test.tsx`

Secondary files only if additive data is required:
1. `crates/hydra-app/src/ipc_types.rs`
2. `crates/hydra-app/src/commands.rs`
3. `crates/hydra-app/src/state.rs`

## 7. Evidence Pack Required for Closure

1. Before/after desktop screenshots at `1366x768` and `1920x1080`.
2. One short recording of the full cockpit loop:
   launch -> stream -> intervention -> completion -> review jump.
3. Test command output logs for all required commands.
4. List of regressions checked and explicit statement if none found.

## 8. Implementation Order (Local)

1. `M4.7.1` Cockpit shell/layout
2. `M4.7.2` Center race config convergence
3. `M4.7.3` Right leaderboard model
4. `M4.7.4` Focused terminal panel
5. `M4.7.5` Inline intervention
6. `M4.7.6` Completion summary + review bridge
7. `M4.7.7` Error/degradation UX
8. `M4.7.8` QA hardening + regression gate

## 9. Coordination Notes

1. Keep race/results/review behavior backward-compatible while converging to
   cockpit default.
2. Keep design-token enforcement (`no hardcoded hex`) for all new UI code.
3. Use `planning/local-execution-conventions.md` for status/evidence discipline.
4. Follow desktop behavior contract in `planning/m4.7-desktop-ui-contract.md`.
